// Module included in the following assemblies:
//
// * authentication/identity_providers/configuring-ldap-identity-provider.adoc

[id="example-apache-httpd-configuration_{context}"]
= Example Apache HTTPD configuration for basic identity providers

The basic identify provider (IDP) configuration in {product-title} 4 requires
that the IDP server respond with JSON for success and failures. You can use CGI
scripting in Apache HTTPD to accomplish this. This section provides examples
with an httpd server configured as a running pod in cluster.

.Use project "default"
----
PROJECT=httpd-proj
APP=httpd
SVC=basic-auth
IDP_NAME=basicauth-idp
oc new-project $PROJECT
----

.Deploy & Configure the HTTPD Server
----
oc get is httpd -n openshift

NAME    IMAGE REPOSITORY                                                   TAGS                         UPDATED
httpd   image-registry.openshift-image-registry.svc:5000/openshift/httpd   2.4,2.4-el7,2.4-el8,latest   59 minutes ago

oc create deployment $APP --image image-registry.openshift-image-registry.svc:5000/openshift/httpd:2.4 -- bash -c "cp /tmp/httpd/login.conf /etc/httpd/conf.d/ssl.conf; httpd -D FOREGROUND"
oc expose deployment/$APP --name $SVC --port 8443
oc annotate service $SVC service.beta.openshift.io/serving-cert-secret-name=httpd-cert
----

.Use cat > login.conf << EOF
----
Listen 0.0.0.0:8443 https

<VirtualHost *:8443>
  # CGI Scripts in here
  DocumentRoot /var/www/cgi-bin

  # SSL Directives
  SSLEngine on
  SSLProxyCipherSuite PROFILE=SYSTEM
  SSLCertificateFile /etc/httpd/conf/tls/basic-auth/tls.crt
  SSLCertificateKeyFile /etc/httpd/conf/tls/basic-auth/tls.key

  # Configure HTTPD to execute scripts
  ScriptAlias /basic /var/www/cgi-bin

  # Handles a failed login attempt
  ErrorDocument 401 /basic/fail.cgi

  # Handles authentication
  <Location /basic/login.cgi>
    AuthType Basic
    AuthName "Please Log In"
    AuthBasicProvider file
    AuthUserFile /etc/httpd/conf/auth/passwords
    Require valid-user
  </Location>
</VirtualHost>
EOF
----

.Use cat > login.cgi << 'EOF' With Single Quotes
----
#!/bin/bash
echo "Content-Type: application/json"
echo ""
echo "{\"sub\":\"$REMOTE_USER\", \"preferred_username\":\"$REMOTE_USER\", \"name\":\"Hello $REMOTE_USER\"}"
exit 0
EOF
----

.Use cat > fail.cgi << EOF
----
#!/bin/bash
echo "Content-Type: application/json"
echo ""
echo '{"error": "Login failure"}'
exit 0
EOF
----

.Add Passwords for basicauth-xxia
----
htpasswd -bc passwords basicauth-xxia1 redhat
htpasswd -b passwords basicauth-xxia2 redhat
----

.Create & Set Volumes
----
oc create secret generic auth --from-file=passwords
oc create cm cgi-bin --from-file=login.cgi --from-file=fail.cgi
oc create cm login.conf --from-file=login.conf
oc set volumes deployment/$APP --add -t secret --secret-name auth -m /etc/httpd/conf/auth
oc set volumes deployment/$APP --add -t configmap --configmap-name cgi-bin -m /var/www/cgi-bin --default-mode 0777
oc set volumes deployment/$APP --add -t secret --secret-name httpd-cert -m /etc/httpd/conf/tls/basic-auth
oc set volumes deployment/$APP --add -t configmap --configmap-name login.conf -m /tmp/httpd
----

.Results
----
oc get pod

NAME                     READY   STATUS    RESTARTS   AGE
httpd-7d4d97bc96-4kzgq   1/1     Running   0          9
----

== File requirements

These are the requirements for the files you create on an Apache HTTPD web
server:

* `login.cgi` and `fail.cgi` must be executable (`chmod +x`).
* `login.cgi` and `fail.cgi` must have proper SELinux contexts if SELinux is
enabled: `restorecon -RFv /var/www/cgi-bin`, or ensure that the context is
`httpd_sys_script_exec_t` using `ls -laZ`.
* `login.cgi` is only executed if your user successfully logs in per `Require
and Auth` directives.
* `fail.cgi` is executed if the user fails to log in, resulting in an `HTTP 401`
response.
